
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Amazon Super Search â€“ Final Fixed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css">
  <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.min.js"></script>
</head>
<body>
<audio id="clickSound" src="click.mp3" preload="auto"></audio>

<form id="amazon-search-form">
  <input name="q" placeholder="Search term">
  <input type="number" name="min-price" placeholder="Min Price">
  <input type="number" name="max-price" placeholder="Max Price">
  <input name="brand-include" id="brandInclude" placeholder="Include brands">
  <input name="brand-exclude" id="brandExclude" placeholder="Exclude brands">
  <input type="checkbox" name="include-only" id="includeOnly"> Include Only<br>
  <select name="percent-off">
    <option value="">% Off</option>
    <option value="10">10%</option>
    <option value="20">20%</option>
    <option value="30">30%</option>
  </select>
  <select name="sort">
    <option value="">Sort</option>
    <option value="price-asc-rank">Price Low to High</option>
  </select>
  <input type="checkbox" name="lightning-deals" id="lightningDeals"> Lightning Deals
  <input type="checkbox" name="fba-only" id="fbaOnly"> Sold by Amazon
  <input type="checkbox" name="enable-boolean" id="enableBoolean"> Boolean
  <input name="field-filters" placeholder="field-brand:Sony">
  <input name="direct-lookup" placeholder="ASIN/ISBN">
  <button type="submit" onclick="document.getElementById('clickSound').play()">Search</button>
</form>

<div id="filter-warning" style="color: orange; display: none; font-weight: bold;"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('amazon-search-form');
  const warningBox = document.getElementById('filter-warning');

  new Tagify(document.querySelector('input[name="brand-include"]'), {
    whitelist: ["Sony", "Samsung", "LG", "Acer", "Apple", "Dell"]
  });
  new Tagify(document.querySelector('input[name="brand-exclude"]'), {
    whitelist: ["Sony", "Samsung", "LG", "Acer", "Apple", "Dell"]
  });

  form.addEventListener('submit', e => {
    e.preventDefault();

    const checked = [...form.elements].filter(el =>
      el.type === 'checkbox' && el.checked && !el.closest('.coming-soon')
    ).length;
    warningBox.style.display = checked > 2 ? 'block' : 'none';

    ['brandInclude', 'brandExclude'].forEach(id => {
      const tagifyInput = document.getElementById(id);
      if (tagifyInput && tagifyInput._tagify) {
        tagifyInput.value = JSON.stringify(tagifyInput._tagify.value);
      }
    });

    const data = new FormData(form);
    const params = new URLSearchParams();
    const rh = [];

    const min = data.get('min-price')?.trim();
    const max = data.get('max-price')?.trim();
    if (min && max) rh.push(`p_36:${Math.round(min*100)}-${Math.round(max*100)}`);
    else if (min) rh.push(`p_36:${Math.round(min*100)}-`);
    else if (max) rh.push(`p_36:-${Math.round(max*100)}`);

    const brandInclude = data.get('brand-include');
    const brandExclude = data.get('brand-exclude');
    if (brandInclude) JSON.parse(brandInclude).forEach(obj => rh.push(`p_89:${encodeURIComponent(obj.value)}`));
    if (brandExclude) JSON.parse(brandExclude).forEach(obj => params.append('brand-exclude', obj.value));

    if (data.get('fba-only') === 'on') rh.push('p_6:ATVPDKIKX0DER');
    if (data.get('lightning-deals') === 'on') rh.push('p_n_deal_type:23566065011');

    const percentOff = data.get('percent-off');
    const discountMap = {
      "10": "2665401011", "20": "2665412011", "30": "2665413011"
    };
    if (percentOff && discountMap[percentOff]) rh.push(`p_n_pct-off-with-tax:${discountMap[percentOff]}`);

    if (data.get('enable-boolean') === 'on') params.set('boolean', 'on');
    if (data.get('field-filters')) params.set('fields', data.get('field-filters').trim());
    if (data.get('direct-lookup')) params.set('asin', data.get('direct-lookup').trim());

    const sort = data.get('sort');
    if (sort) params.set('s', sort);

    const query = data.get('q');
    if (query) params.set('k', query);

    if (rh.length) params.set('rh', rh.join(','));
    params.set('tag', 'echolover25-20');

    const finalUrl = `https://www.amazon.com/s?${params.toString()}`;
    window.open(finalUrl, '_blank');
  });
});
</script>
</body>
</html>
